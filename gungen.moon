-- title:  Tiny Gun Generator
-- author: congusbongus
-- desc:   Randomly generate pixel gun icons
-- script: moon

S_UPPER=0
S_GRIP=64
S_MAG=80
S_STOCK=96
S_SCOPE=128
S_BARREL=144
S_FGRIP=112

-- left edge of upper - align stock here
UPPER_LEFT={
	2,3,3,3,
	1,2,1,0,
	3,2,0,1,
	1,0,0,0,
	0,0,
}
-- top edge of upper - align scope here
UPPER_TOP={4,4,5,4,4,4,4,5,4,4,5,5,5,4,3,5,5,4}
-- right edge of upper - align barrel here
UPPER_RIGHT={
	3,5,4,4,
	1,2,5,3,
	5,8,3,5,
	2,0,0,0,
	2,0,
}
-- position of barrel on the upper
UPPER_BARREL_Y={5,5,6,5,6,5,6,6,5,6,6,6,6,6,6,6,6,6}
UPPER_MAG_W={
	0,0,0,0,
	4,0,2,3,
	0,0,4,2,
	3,4,4,4,
	4,4,
}

GRIP_W={5,5,5,5,4,5,4,5,4,5,4,6,3,4,5,4}
MAG_W={0,2,2,4,1,4,4,4,3,4,3,4,3}

N_PARTS = {
	upper:18,
	grip:16,
	mag:13,
	stock:15,
	scope:8,
	barrel:8,
	fgrip:4,
}

indices = {
	upper:0,
	grip:0,
	mag:0,
	stock:0,
	scope:0,
	barrel:0,
	fgrip:0,
}

PALETTES={
	default:"140c1c302c303c3c3c402428714c304c4c4cd04648757161597dced27d2c9195916daa2cd2aa996dc2cababebedeeed6",
	verdant:"140c1c342c243c3c201824145d4c30614c20d04648697148597dce617d2c75955d6daa2cd2aa996dc2cabebe8deeeeee",
	desert:"140c1cbea575503c2440342871503065654cd04648b29961597dce717d2cb695656daa2cd2aa996dc2cad2be7df2eed6",
	winter:"140c1ccececee2e2e2402428c2c2c2eeeeeed04648bebebe597dceffffff9195916daa2cd2aa996dc2cababebedeeed6",
	black:"140c1c302c303c3c3c4040402020204c4c4cd04648202020597dce3030303030306daa2cd2aa996dc2ca5d5d5ddeeed6",
}
IDX_PALETTE={}
PALETTE_IDX={}
N_PALETTES=0
for k,v in pairs(PALETTES)
  IDX_PALETTE[N_PALETTES]=k
  PALETTE_IDX[k]=N_PALETTES
  N_PALETTES=N_PALETTES+1
palette=IDX_PALETTE[0]

loadpalette=(pal)->
	for i=0,15
		r=tonumber(string.sub(pal,i*6+1,i*6+2),16)
		g=tonumber(string.sub(pal,i*6+3,i*6+4),16)
		b=tonumber(string.sub(pal,i*6+5,i*6+6),16)
		poke(0x3FC0+(i*3)+0,r)
		poke(0x3FC0+(i*3)+1,g)
		poke(0x3FC0+(i*3)+2,b)

mllast=false
mmlast=false
mrlast=false

modwrap=(x,m)->
	(x%m+m)%m

class Menu
    new:(x=0,y=0,index=1,spc=10)=>
        @x=x
        @y=y
		@spc=10
        @index=index
        @items={}
    
    add:(text)=>
        table.insert(@items,text)

    prev:=>
        i=@index-1
        if i<1
            @index=#@items
        else
            @index=i
    
    next:=>
        i=@index+1
        if i>#@items
            @index=1
        else
            @index=i

	onmousemove:(mx,my)=>
		if mx<@x or mx>@x+60
			return
		for k,v in ipairs(@items)
			if my<@y
				continue
			dy=@y+(k-1)*@spc
			if my>dy+@spc
				continue
			@index=k
			break

    draw:(sel="> ",usel="  ",col=15)=>
        for k,v in ipairs(@items)
            dy=@y+(k-1)*@spc
			prefix=usel
			tcol=col
			if @index==k
				prefix=sel
				tcol=6
			suffix=""
			if k<#@items-1
				suffix=" "..indices[v]
			elseif k==#@items-1
				suffix=" "..palette
			print prefix..v..suffix,@x,dy,tcol

menu = Menu 140,20
menu\add "upper"
menu\add "grip"
menu\add "mag"
menu\add "stock"
menu\add "scope"
menu\add "barrel"
menu\add "fgrip"
menu\add "palette"
menu\add "shuffle..."

drawgun=(x,y,scale)->
	uleft=UPPER_LEFT[indices.upper+1]
	uright=UPPER_RIGHT[indices.upper+1]
	uby=UPPER_BARREL_Y[indices.upper+1]

	-- Draw stock - up against upper's left
	spr indices.stock+S_STOCK,x-(8-uleft)*scale,y+4*scale,0,scale,0,0,1,1
	-- Draw scope - above upper, aligned to upper's left
	spr S_SCOPE+indices.scope*2,x+uleft*scale,y-(7-UPPER_TOP[indices.upper+1])*scale,0,scale,0,0,1,1
	spr S_SCOPE+indices.scope*2+1,x+(8+uleft)*scale,y-(7-UPPER_TOP[indices.upper+1])*scale,0,scale,0,0,1,1
	-- Draw barrel - to the right of upper
	spr S_BARREL+indices.barrel*2,x+(16-uright)*scale,y+(-5+uby)*scale,0,scale,0,0,1,1
	spr S_BARREL+indices.barrel*2+1,x+(16-uright)*scale,y+(-5+uby)*scale,0,scale,0,0,1,1
	-- Draw forward grip right below barrel
	spr indices.fgrip+S_FGRIP,x+(16-uright)*scale,y+(1+uby)*scale,0,scale,0,0,1,1
	-- Draw upper
	spr S_UPPER+indices.upper*2,x,y+1*scale,0,scale,0,0,1,1
	spr S_UPPER+indices.upper*2+1,x+8*scale,y+1*scale,0,scale,0,0,1,1

	-- If there is a mag, draw grip/mag group offset futher to the left
	gripoff=0
	if indices.mag>0
		gripoff=-3
	-- Draw grip
	spr indices.grip+S_GRIP,x+gripoff*scale,y+(8-1)*scale,0,scale,0,0,1,1
	-- Draw mag
	spr indices.mag+S_MAG,x+(7+gripoff)*scale,y+(8-1)*scale,0,scale,0,0,1,1

export TIC=->
	if btnp 0	-- up
		menu\prev!
	if btnp 1	-- down
		menu\next!
	mx,my,ml,mm,mr=mouse!
	menu\onmousemove mx,my

	press1=btnp(3) or btnp(4) or (not mllast and ml)	-- right or A or lmb
	press2=btnp(2) or btnp(5) or (not mrlast and mr)	-- left or B or rmb

	paletteidx=nil
	if menu.index<#menu.items-1
		var=menu.items[menu.index]
		if press1
			indices[var]=modwrap indices[var]+1,N_PARTS[var]
		elseif press2
			indices[var]=modwrap indices[var]-1,N_PARTS[var]
	elseif menu.index==#menu.items-1
		if press1
			paletteidx=modwrap PALETTE_IDX[palette]+1,N_PALETTES
		elseif press2
			paletteidx=modwrap PALETTE_IDX[palette]-1,N_PALETTES
	else
		-- Shuffling
		if press1 or press2
			for i=1,#menu.items-2
				var=menu.items[i]
				indices[var]=math.random(N_PARTS[var])-1
			-- Check upper/mag compatibility
			while UPPER_MAG_W[indices.upper+1]<MAG_W[indices.mag+1] or UPPER_MAG_W[indices.upper+1]>0 and MAG_W[indices.mag+1]==0
				indices.mag=math.random(N_PARTS.mag)-1
			-- Remove fgrip if no barrel
			if indices.barrel==0
				indices.fgrip=0
	if paletteidx
		palette=IDX_PALETTE[paletteidx]
		loadpalette PALETTES[palette]
	mllast=ml
	mmlast=mm
	mrlast=mr

	cls 0
	-- Draw gun in multiple scales
	drawgun 47,0,1
	drawgun 42,12,2
	drawgun 37,35,3
	drawgun 32,70,4
	menu\draw!

-- <TILES>
-- 000:00000000000000000000000000000000000aaaae00a77aae00aaaaaa000a0000
-- 001:00000000000000000000000000000000eeeee000eeeee000aaaa000000000000
-- 002:0000000000000000000000000000eeee000efffa000e777e000eeeee00000000
-- 003:00000000000000000000000000e00000aaa00000eee000000000000000000000
-- 004:0000000000000000000000000000000000000000000eeaae00eeaaee000e0000
-- 005:0000000000000000000000000000000000000000eeee0000eeaa000000000000
-- 006:00000000000000000000000000000000000eaaee00e555ee0055555500000000
-- 007:00000000000000000000000000000000aaa7000055550000aaaa000000000000
-- 008:0000000000000000000000000000000000aaaaaa011111111111111100000007
-- 009:00000000000000000000000000000000aaaa99001111999a1111999000000000
-- 010:00000000000000000000000000000000000eaaa100e7777700a1111100000000
-- 011:000000000000000000000000000000001aaa7700777777001110000000000000
-- 012:000000000000000000000000000700000f77aaa7077777770a11611100000000
-- 013:000000000000000000000000700000007a000000771000001111000000000000
-- 014:000000000000000000000000000000000fe00007feeaaaaae77777770e000000
-- 015:0000000000000000000000000000000000007000eeeee0007777700000000000
-- 016:00000000000000000000000000000007000e11ee00071177000eeeee00000000
-- 017:00000000000000000000000000700000eee0000077777000eee0000000000000
-- 018:0000000000000000000000000000ff70000777770077eeee0077777700000000
-- 019:0000000000000000000000000000000000000000000000007000000000000000
-- 020:0000000000000000000000000000000000000000044444444444444444400000
-- 021:0000000000000000000000000000000000000000444440004444400000000000
-- 022:0000000000000000000000000000000000000000049999990999999900000000
-- 023:0000000000000000000000000000000000000000444000004440000000000000
-- 024:0000000000000000000000000000000001000000011007771111111100000000
-- 025:0000000000000000000000000000000000000100777111001111111100000000
-- 026:00000000000000000000000001000001011aaaa7111111111111111100000000
-- 027:0000000000000000000000000000011077777010111111111111111100001110
-- 028:0000000000000000000000000722222272222222222222222222222200000000
-- 029:0000000000000000000000002777770022777700221111112211111100000000
-- 030:0000000000000000000000000000000000000000777777ae777777ae00000000
-- 031:0000000000000000000000000000000000002000555552225555522200000000
-- 032:000000000000000000000000000000000e0000000eeeeeee4aaaaaaa44000000
-- 033:000000000000000000000000000000000000e000eeeee997aaaa990000000000
-- 034:0000000000000000000000000010000005111111577777777777777700000000
-- 035:0000000000000000000000000000e00011111000777771117777711100000000
-- 064:00000000000110070001177700711e0000711e0000011e00000eee0000000000
-- 065:004000000444e00e33344eee3340000033400000000000000000000000000000
-- 066:00000000000ff007000ff77000ffe00000ffe00000eee0000000000000000000
-- 067:0000000000057705000577550077770000777000007770000000000000000000
-- 068:0000000000009001000991100009900000099000000000000000000000000000
-- 069:0000000000077007000aa7770077100000771000001110000000000000000000
-- 070:00000000000077010000a7100000aa0000000000000000000000000000000000
-- 071:000000000077a00100eaa11000aa70000ea7000000e700000000000000000000
-- 072:000000000000aa070000aa770000aa000000aa00000177000000770000007700
-- 073:0000000000077071001777100000700000000000000000000000000000000000
-- 074:000000000000a00a0000eaaa000ea000000a7000000000000000000000000000
-- 075:0000000000777007007717700001100000011000000000000000000000000000
-- 076:0000000000000101000011100000110000001100000000000000000000000000
-- 077:0000000000005005000555500005500000051000000000000000000000000000
-- 078:0000000000022005000200500002050000055000000000000000000000000000
-- 079:0000000000007007000077770007700a00077aa0000000000000000000000000
-- 081:0000000007a0000007a000000a10000000000000000000000000000000000000
-- 082:00e000000ae000000a700000077000000a7000000a7000000a70000000000000
-- 083:000000000a7a70000a7a70000777100000000000000000000000000000000000
-- 084:0000000007000000070000000700000000000000000000000000000000000000
-- 085:0000000002121000021210000111100000000000000000000000000000000000
-- 086:000000000a77a0000a7700000a77000000570000000000000000000000000000
-- 087:000000000aaae0000aaee0000aae00000aae0000000000000000000000000000
-- 088:000000000a7100000a71000000a71000000a71000000a1000000000000000000
-- 089:0000000001111000022200000222000002220000011100000000000000000000
-- 090:000000000a7a00000a7a00000a7aa00000a7a00000aa7a00000aa00000000000
-- 091:0000000007171000071710000071710000771710000771100000110000000000
-- 092:0000000001210000012100000121000001211000001210000011110000011000
-- 097:0000000000000000000000e7000000ee000000ee000000110000001000000000
-- 098:00000000000000000aaaaeee0a7777770a777770011117770000007700000000
-- 099:0000000000000000099999990999990009990000000000000000000000000000
-- 100:0000000000000000011111990111999901999000019900000000000000000000
-- 101:0000000000009991499999994999000949900099499999900000000000000000
-- 102:000000000000000000000000000001aa00000100000001000000000000000000
-- 103:000000000000000000a5555500a5555500a5500000a500000005000000050000
-- 104:0000000000000000211111112111111122222222222222222222000020000000
-- 105:00000000000000000555555505555555055aa000055a00000000000000000000
-- 106:0000000000000000071111110777770007000000070000000000000000000000
-- 107:0000000000000000a1111111a1111111a1111a00a111a000a11a000000000000
-- 108:0000000000000000111111111111111111001100110011001111100011100000
-- 109:0000000000000000009999990044444400444400004440000044000000000000
-- 110:000000000000000100e1111100a7777700a7777700e0000000e0000000000000
-- 113:0000000005500000055000000550000005100000000000000000000000000000
-- 114:0000000001000000010000000100000001000000010000000000000000000000
-- 115:0eaea0000aaaa000000000000000000000000000000000000000000000000000
-- 130:0000000000000000000000000000000000000000a1eeeee0a1eeeee011110000
-- 132:000000000000000000000000000000000000000000000000777777aa77777700
-- 133:000000000000000000000000000000000000000000000000a770000007700000
-- 134:000000000000000000000000000000000000000000000000eeeaaaae0000a000
-- 135:000000000000000000000000000000000000000000000000eeea0000e0000000
-- 136:0000000000000000000000000000000000000000000005000aaa77770aaa7777
-- 137:0000000000000000000000000000000000000000000a000077aa000077aa0000
-- 138:00000000000000000000000000000000000000000000000000aaaaaa00aaaaaa
-- 139:000000000000000000000000000000000000000000000000a0000000a0000000
-- 140:0000000000000000000000000000000000000000ee000000eeaaaaaa00a00000
-- 141:000000000000000000000000000000000000000000000000a555200005555200
-- 142:00000000000000000000000000000000000000000e1111110a0000000aa00000
-- 143:0000000000000000000000000000000000000000000000001000000001000000
-- 146:0000000000000000000000000000000000000000111111111111111100000000
-- 148:0000000000000000000000000000000000000000999999919999999000000000
-- 149:0000000000000000000000000000000001000000111000000000000000000000
-- 150:000000000000000000000000000000000000000044444aaa44444aaa00000000
-- 151:0000000000000000000000000000000000000000aaa00000aaa0000000000000
-- 152:00000000000000000000000000000000000000002277aa772277aa7700000000
-- 153:0000000000000000000000000000000000000000110000001100000000000000
-- 154:0000000000000000000000000000000000a00000111a00001111aaaa00000000
-- 156:00000000000000000000000000000000000000009999900099999aaa99900000
-- 158:0000000000000000000000000000000000000000ee999977a999900000000000
-- </TILES>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <PALETTE>
-- 000:140c1c302c303c3c3c402428714c304c4c4cd04648757161597dced27d2c9195916daa2cd2aa996dc2cababebedeeed6
-- </PALETTE>

-- <COVER>
-- 000:50a000007494648393160f00880077000012ffb0e45445353414055423e2033010000000129f40402000ff00c2000000000f0088007841c0c1ebebd843c2425759d516c402961784d5c403814241eeeeee0d648400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080ff001080c1840b0a1c388031a2c58c0b1a3c780132a4c9841b2a5cb88133a6cd8c1b3a7cf80234a8c1942b4a94e810408ac5972b5abc790393e00382026adcb9833720010306661ca9b357a0d1a44522183a84908a41850a9a3d59a2b96fc6a54baa551a94908108ac5bba009a308ae5d1b46b5e1de9602d60018102cafcf9563eac53976f08d55b10ad6187b4018ecdfb08d3edd28e69fa04fb1831b26a83890fe5a9b832b4eb835d032e9c8933f2ce9a9b3b7efc0a34b8e1d4ab4b9e3d8a35ffdcbe59baae7da3957b6690bb67c4ecb079ad6e8800180ceddb77b04cda057b9e0e00c7307fd9c18f047edc193148efc993c659d3987243eb3f27664eac9978ffffddcbc387382d9af57e99d91277eea9fcbc71f1dba7240f6d1476ddf841a2147a006083bd75e456716935f7147bcdf64d9289fd47ecd27f0666cf1f7efd041066850c0800a1800e262d5972c53451e1596d08822a8d1667f1e88aa598a5d6592ec8d5da835128e26a694918965f8604e5405e573a675c97793ee6b3667e32e5146b570219bd919746d694ad565e10e36e5a5a39069340fd861222416eb655e59856f8b5a09f4a1615676e0689b0614ae9b8756a5a0d09de5e6256262ed879c9974f9c931a0757a1077ea9052d4b760621a88c0a8831e8948a5967e66b6ab7b8a261c588b9ec91dd0a6b51ac01e989ab92924835a74e1ee5c66f5996aa0b22ff4ba62a30d791beda692da8beea31918cbefa0ca749ed9a1cad6b96578f54a8f93a5ce88d86f9f723bf86d70a63bfa927f724bd8a0a3d65b2c96943e584a16bd727af06c9e9e190e68b6b2c69ea5bbe2bb6defa972444bdcb0b6dbf0ddb8fe49afa79de6fbbe1b7eb644cfe1610b6aed27b2621b7ada460aea15a777033a112ab3c67a4e1aa1d6d60174c2155c517286ead79d66c386c9291c8c27756096803f354366811f18d2ad4e0a9c1e9577e989891bc03abc505cc1378b4374c912ecaedb98caf9ace2c3710d52a0dff11da1a1d106dc94b0c7294d62e98ce68d3376d84708c577de57f826fada229dbaedc76f84e57c8232bd6737574fbd836cd2776ff553f299520950969c2285da20cfa2fdf2de7f730e87da538ba963ffb6f62c9ad6bb2bfd11b3ef8b1448fd8cae1ed0d8c3616c9c23891fd7057c5c87f46661a187a92971821be998b05d0e0b4edc72de4b395be30cbe49e292bf7e397de54ede34d5cc33d73f18ae03060cb0f7711f5cb397cb8e89a2f939ac6a3aedcb2b6adbed3e345878e49f6f06eae9a19f596347e7dc12b5ea8f05eeb1ae05cf02b1c4f7dfa3ddf211df96f0124a3ff11500811110ecf8b760489020122a04ef130f621db8801ba286b1da91e6f5df3cd5eea359ca0f9fe405ce38d860347c1c90a2d677f82edd9c00570936ddae489e3206705722f9616e7cc5dcb81aac668bfb17d70ffdf432caf0aec76cb29f530185a4c52a31f9805c82a417a845c68dae2a7f3ca22886781242165b0385a9d2ddde6861b809e0777e434f0813c81f2bbdafa964448167ca88fda632bded8cda29561f3552c1d8817c8793c26f1773503b888b4b829924654e0988c5c822922c8c64626e1931984a423e2059a912f6b7252b4a5c41252b090817d8d19c4a62132e94f4215cb77138059b0487a36859b0c7d43a5a9e849a11356317194a355e2fc9776c066825e8a33816e0dc32c4a3a94479144e56bbc79e1461213796c5446951f88324d6523b77a099b94da53801ba983734b6389962d6666bd80b23694d411a111d3eac22ed21256d421973b56e5907e83986cff6337a62166cb914e86ee98f4aad0d6f954b27a68ec9005722143869fc3802431a263f7e903d9b4c782ddae636ce8e8d2f656bda564f1ae32f8a9476461d09264b18a1d29e94f5ada949aed0e60194043421063d580e437a008d96f497a18969aad06a4458a8c4fc7b2d88005702b35b96355028358a24518a15d9a214c7aca3efc939371b38c97ec878e4a4a12b085295a265f7a25daaa35f9ad4d5b235dda569a0d659baf83fa64e42716da12429ca3295aeb51ea085baeb570b355e9645f0be75b98c553947dab2246b4a731ba335589194ce351dad3d2c21650ba9df96e411b895d9c26b1747dd2d361ca63a10a4092b35c1d60f8a73c30cd5f02b8459cfcee59c88847d2c636b6db9d26f2fab9c412b65a8abddde9946bebdfd6a69320dcb4a04a8bbb5ec52759b4bb0e22e68bec51805fc744198ce92f22dcdcee246bb5ebe55d6fbb365cda87b024ed7f520fcbbbcbd2673bbde5cf5001ebdc49fea7b225f5c8877dab31b9fa37bfb491cf2a29fabfd48018d22ff55d27231c31950754a1c7065f248942c0daea38f021edb07b423c68bd0b2ac2ce1e090881d7afd21b05e4c6b5bd90855cd19372c874323e91786a6c63efc0e837cc3ee1bf8f7c04e02b0978c44e22b19f8c84e427e8302000b3
-- </COVER>

